---
title: "Stat 763 HW 2"
author: "Matt Allen"
date: "2/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("pdftools")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r readdata}
library(tidyverse)
library("pdftools")
#filenames
heights_file_name <- '/home/rstudio/assign2/heights.pdf'
ice_cream_file_name <- '/home/rstudio/assign2/ice_cream.csv'

#temp_file <- tempfile()
#url <- paste0("http://www.pnas.org/content/suppl/2015/09/16/",
#              "1510159112.DCSupplemental/pnas.201510159SI.pdf")
#download.file(url, temp_file)
#txt <- pdf_text(temp_file)
#file.remove(temp_file)




#ice_cream_raw <- read.csv2(ice_cream_file_name,sep=",")
#str_split(ice_cream_raw$preference,",")
#https://tidyr.tidyverse.org/reference/separate.html

ice_cream <- read.csv2(ice_cream_file_name,sep=",") %>%
  separate(preference, c("Preference_1","Preference_2","Preference_3"), 
           sep = ",", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn") %>%
  mutate_all(str_trim)


#heights_raw <- pdf_text(heights_file_name)




#str_split(heights[[2]],"\\s+")

# heights
# 
# 
# 
# 
# blarg <- ice_cream_raw %>%
#   separate(preference, heights_col_names, 
#            sep = "\\s+", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn")
# 
# 
# #https://stackoverflow.com/questions/48833807/initialize-an-empty-tibble-with-column-names-and-0-rows
# 
# create_heights_tibble <- function(heights_pdf_text) {
#   page_num <- 1
#   row_num <- 2 # start row num at 2 because first page has columns
#   
#   
#   heights <- str_split(heights_pdf_text, "\n") 
#   heights_col_names <- str_split(heights[[page_num]][row_num],"\\s+")
#   
#   
#   
#   testy <- tibble(heights_col_names)
#   for(page in heights) {
#     #if(page_num == 1 && row_num == 1) {
#       #the first page has the row headers so need to process that one differently
#       #heights_col_names <- str_split(heights[[1]][1],"\\s+")
#       #create data table
#     #}
#     rows = str_split(page,"\\s+")
#     
#     #for(row in rows) {
#       #if(length(row) == length(heights_col_names)) {
#     bind_rows(testy,row)
#       #}
#       
#     #}
#     
#     
#     #row_num <- 1
#     #page_num = page_num + 1
#     
#   }
#   return(testy)
# }
# 
# heights <- create_heights_tibble(pdf_text(heights_file_name))
# 
# 
# ##
# for(page in heights) {
#   rows = str_split(page,"\\s+")
#   rbind()
# }
# 
# 
# which(length(heights[[2]])==3)
# heights[2]
# 
# test2 <- str_split(heights[[2]],"\\s+")
# which(length(test2) == 3)

#https://www.r-bloggers.com/extracting-pdf-text-with-r-and-creating-tidy-data/
heights <- pdf_text(heights_file_name) %>%
  read_lines()

#heights[2]
#heights_split <- str_split(heights[2:length(heights)],"\\s+")


#get rid of empty rows
#can use string split n to throw away empty rows?
#https://stringr.tidyverse.org/reference/str_split.html
heights <- heights[which(str_length(heights) > 0)]

#str_length(heights)
#length(heights)

#str_split(heights[2:length(heights)],"Male|Female", simplify = TRUE)[1:length(heights)]

library(lubridate)
split_on_sex <- str_split(heights[2:length(heights)],"Male|Female", simplify = TRUE)
split_on_sex
dates <- mdy_hm(split_on_sex[1:length(heights)-1,1])



ids <- str_extract(split_on_sex[1:length(heights)-1,2],"([a-zA-Z0-9_]*)$")
#heights_text <- str_extract(split_on_sex[1:length(heights)-1,2],"([a-zA-Z0-9_]*)$")
heights_text <- str_sub(split_on_sex[1:length(heights)-1,2],1,str_length(split_on_sex[1:length(heights)-1,2])-str_length(ids))
length(heights_text)
#length(ids)

#length(dates)
sex <- str_extract(heights[2:length(heights)],"Male|Female")
length(sex)
heights <- tibble(id = ids, reported_date = dates, sex = sex, height_text = str_trim(heights_text))


#work on recode height text

#as.numeric(heights$height_text)
#which(is.na(as.numeric(heights$height_text)))
heights$height_text[which(is.na(as.numeric(heights$height_text)))]

recode(heights$height_text, 
                          `Antigua and Barbuda` = "Barbuda",
                          `Dominican Republic` = "DR",
                          `St. Vincent and the Grenadines` = "St. Vincent",
                          `Trinidad and Tobago` = "Trinidad")

```
