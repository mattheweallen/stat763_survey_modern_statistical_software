---
title: "Stat 763 HW 2 Part 1"
author: "Matt Allen"
date: "2/15/2020"
output: html_document
---

```{r change_file_names_here, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#update the name of your file here
#heights filename
heights_file_name <- 'heights.pdf'
#ice cream filename
ice_cream_file_name <- 'ice_cream.csv'
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#built in stat 763 container
#used example here to install poppler to container OS.
#poppler is needed for pdftools
#https://github.com/aabor/rstudio/blob/master/rstudio-text/Dockerfile

library(tidyverse)
library(pdftools)
library(lubridate)
```

```{r my_functions, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#function to clean heights data that are in feet and inches
clean_heights <- function(height_text) {
  #attempt to convert to numeric for all data.
  converted_heights <- as.numeric(height_text)
  
  #change any heights that may have been entered in ft to inches
  entered_as_feet = which(converted_heights >= 5 & converted_heights <= 7)
  converted_heights[entered_as_feet] = converted_heights[entered_as_feet]*12

  #this pattern captures anything with ' or white space between digits
  split_pattern_1 = "\\s*['\\s]+\\s*"
  split_pattern_2 = "\\s*ft\\s*"
  split_pattern_3 = "\\s*feet\\s*"
  split_pattern_4 = "\\s*\\*\\s*"
  split_pattern_5 = "\\s*\\,\\s*"
  split_pattern_6 = "\\s+\\.\\s*"
  split_pattern_7 = "\\s+feet and\\s*"
  
  patterns = c(split_pattern_1, 
               split_pattern_2, 
               split_pattern_3, 
               split_pattern_4, 
               split_pattern_5, 
               split_pattern_6,
               split_pattern_7)
  
  for(p in patterns) {
    number_pattern = paste0("\\d",p,"\\d*")
    if(any(str_detect(heights_text, number_pattern))) {
      ft_inches_which = str_which(height_text,pattern = number_pattern)
      pattern_to_split = heights$height_text[ft_inches_which]
      split_data = str_split(pattern_to_split,p, simplify = TRUE)
      #str_which(heights$height_text,pattern = "\\d'\\d+")
      #blarg1 <- str_split(pattern_to_split,"'", simplify = TRUE)
      
      #take the feet part multiply by 12 and add the inches part to it
      converted_heights[ft_inches_which] = as.numeric(str_trim(split_data[,1]))*12 +   as.numeric(str_trim(str_extract(split_data[,2],"\\d*")))
    }
  }
  return(converted_heights)
}

#function to convert to cm
convert_cm_heights <- function(height_text, converted_heights) {
  cm_which = str_which(height_text,pattern = "cm$")
  cm_heights_converted_to_inches = as.numeric(str_split(height_text[cm_which],"cm$",simplify = TRUE)[,1])*0.393701
  converted_heights[cm_which] = cm_heights_converted_to_inches
  return(converted_heights)
}

```

```{r data_clean, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#--start create tibble for ice cream--#
ice_cream <- read.csv2(paste(getwd(),ice_cream_file_name,sep="/")
                       ,sep=",") %>%
  separate(preference, c("Preference_1","Preference_2","Preference_3"), 
           sep = ",", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn") %>%
  mutate_all(str_trim)

#--start create tibble for height--#
heights <- pdf_text(paste(getwd(),heights_file_name,sep="/")) %>%
  read_lines()

#get rid of empty rows
heights <- heights[which(str_length(heights) > 0)]

#split data by Male and Female
split_on_sex <- str_split(heights[2:length(heights)],"Male|Female", simplify = TRUE)

#convert dates after split
dates <- mdy_hm(split_on_sex[1:length(heights)-1,1])

#get ids
ids <- str_extract(split_on_sex[1:length(heights)-1,2],"([a-zA-Z0-9_]+)$")

#get the heights text
#takes second column of split_on_sex
#and gets substr from beginning of string
#to (the length of the entire string - the length of the id)
heights_text <- str_sub(split_on_sex[1:length(heights)-1,2], 
                        1,
                        str_length(split_on_sex[1:length(heights)-1,2])-str_length(ids)) %>%
                str_squish() %>%
                str_trim()  %>%
                str_replace("^6'$","72") %>%
                str_replace("^Five foot eight inches$","68")  %>%
                str_replace("\"","")

#pull Male and Female from data
sex <- str_extract(heights[2:length(heights)],"Male|Female")

#make tibble from vector created above
heights <- tibble(id = ids, reported_date = dates, sex = sex, 
                  height_text = heights_text)



#clean up feet and height data
cleaned_heigths_data <- clean_heights(heights$height_text)

#convert cm height data
cleaned_heigths_data <- convert_cm_heights(heights$height_text, cleaned_heigths_data)

#add cleaned heights to heights table
heights$cleaned_heigths_data <- cleaned_heigths_data

#join heights and ice cream data
students_ice_cream_heights <- full_join(ice_cream, heights, by = c("student_IDs" = "id"))

#write to file
write.csv(students_ice_cream_heights,"cleaned_ice_cream_full_join_heights.csv")
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r readdata}

#filenames
heights_file_name <- '/home/rstudio/assign2/heights.pdf'
ice_cream_file_name <- '/home/rstudio/assign2/ice_cream.csv'

#temp_file <- tempfile()
#url <- paste0("http://www.pnas.org/content/suppl/2015/09/16/",
#              "1510159112.DCSupplemental/pnas.201510159SI.pdf")
#download.file(url, temp_file)
#txt <- pdf_text(temp_file)
#file.remove(temp_file)




#ice_cream_raw <- read.csv2(ice_cream_file_name,sep=",")
#str_split(ice_cream_raw$preference,",")
#https://tidyr.tidyverse.org/reference/separate.html

ice_cream <- read.csv2(ice_cream_file_name,sep=",") %>%
  separate(preference, c("Preference_1","Preference_2","Preference_3"), 
           sep = ",", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn") %>%
  mutate_all(str_trim)


#heights_raw <- pdf_text(heights_file_name)




#str_split(heights[[2]],"\\s+")

# heights
# 
# 
# 
# 
# blarg <- ice_cream_raw %>%
#   separate(preference, heights_col_names, 
#            sep = "\\s+", remove = TRUE, convert = FALSE, extra = "warn", fill = "warn")
# 
# 
# #https://stackoverflow.com/questions/48833807/initialize-an-empty-tibble-with-column-names-and-0-rows
# 
# create_heights_tibble <- function(heights_pdf_text) {
#   page_num <- 1
#   row_num <- 2 # start row num at 2 because first page has columns
#   
#   
#   heights <- str_split(heights_pdf_text, "\n") 
#   heights_col_names <- str_split(heights[[page_num]][row_num],"\\s+")
#   
#   
#   
#   testy <- tibble(heights_col_names)
#   for(page in heights) {
#     #if(page_num == 1 && row_num == 1) {
#       #the first page has the row headers so need to process that one differently
#       #heights_col_names <- str_split(heights[[1]][1],"\\s+")
#       #create data table
#     #}
#     rows = str_split(page,"\\s+")
#     
#     #for(row in rows) {
#       #if(length(row) == length(heights_col_names)) {
#     bind_rows(testy,row)
#       #}
#       
#     #}
#     
#     
#     #row_num <- 1
#     #page_num = page_num + 1
#     
#   }
#   return(testy)
# }
# 
# heights <- create_heights_tibble(pdf_text(heights_file_name))
# 
# 
# ##
# for(page in heights) {
#   rows = str_split(page,"\\s+")
#   rbind()
# }
# 
# 
# which(length(heights[[2]])==3)
# heights[2]
# 
# test2 <- str_split(heights[[2]],"\\s+")
# which(length(test2) == 3)

#https://www.r-bloggers.com/extracting-pdf-text-with-r-and-creating-tidy-data/
heights <- pdf_text(heights_file_name) %>%
  read_lines()

#heights[2]
#heights_split <- str_split(heights[2:length(heights)],"\\s+")


#get rid of empty rows
#can use string split n to throw away empty rows?
#https://stringr.tidyverse.org/reference/str_split.html
heights <- heights[which(str_length(heights) > 0)]

#str_length(heights)
#length(heights)

#str_split(heights[2:length(heights)],"Male|Female", simplify = TRUE)[1:length(heights)]


split_on_sex <- str_split(heights[2:length(heights)],"Male|Female", simplify = TRUE)
split_on_sex
dates <- mdy_hm(split_on_sex[1:length(heights)-1,1])



ids <- str_extract(split_on_sex[1:length(heights)-1,2],"([a-zA-Z0-9_]*)$")
#heights_text <- str_extract(split_on_sex[1:length(heights)-1,2],"([a-zA-Z0-9_]*)$")
heights_text <- str_sub(split_on_sex[1:length(heights)-1,2],1,str_length(split_on_sex[1:length(heights)-1,2])-str_length(ids))
length(heights_text)
#length(ids)

#length(dates)
sex <- str_extract(heights[2:length(heights)],"Male|Female")
length(sex)
heights <- tibble(id = ids, reported_date = dates, sex = sex, height_text = str_trim(heights_text))


#work on recode height text

#as.numeric(heights$height_text)
#which(is.na(as.numeric(heights$height_text)))
weird_heights <- heights$height_text[which(is.na(as.numeric(heights$height_text)))]
length(weird_heights)
str_squish(weird_heights)
#str_view(c("abc", "def", "fgh"), "abc")
str_view(str_squish(weird_heights),pattern = "\\d'\\d+")

#got a bunch on this, took care of 47 with 30 left to find
sum(is.na(str_extract(str_squish(weird_heights),pattern = "\\d'\\d+")))


#str_view_all(c("abc", "def", "fgh"), "d|e")

#(fruit, "^([aeiou])")

#recode(heights$height_text, 
#                          `Antigua and Barbuda` = "Barbuda",
#                          `Dominican Republic` = "DR",
#                          `St. Vincent and the Grenadines` = "St. Vincent",
#                          `Trinidad and Tobago` = "Trinidad")

#in str_view documentation
#https://www.garrickadenbuie.com/project/regexplain/

```
