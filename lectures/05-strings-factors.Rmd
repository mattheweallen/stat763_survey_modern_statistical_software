---
title: "Strings and Factors"
author: "STAT 763 - Survey of Modern Statistical Software"
output: ioslides_presentation
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(out.width = '80%', collapse = TRUE, warning=FALSE, message=FALSE)
```

## Agenda

- Strings
- Regular expressions
- Factors

- Readings: R4DS Chapters 14-15
- Other sources: 
  - [RegEx cheatsheat](https://rstudio.com/wp-content/uploads/2016/09/RegExCheatsheet.pdf)

## String basics

```{r}
library(tidyverse)
string1 <- "This is a string"
string2 <- 'If I want to include a "quote" inside a string, I use single quotes'
```

## String basics

```{r}
double_quote <- "\"" # or '"'
single_quote <- '\'' # or "'"
```

## String basics

```{r}
x <- c("\"", "\\")
x
#> [1] "\"" "\\"
writeLines(x)
```

Other characters: try `?'"'`
  
## String operations

String processing tasks can be divided into:

- detecting, 
- locating, 
- extracting, or 
- replacing

## `stringr` functions

| stringr     | Task     | Description                              | R-base |
|--------------- |----------|--------------------------------------|-------------|
| `str_detect` | Detect | Is the pattern in the string? | `grepl` |
| `str_which` | Detect | Returns the index of entries that contain the pattern. |  `grep` |
| `str_subset` | Detect | Returns the subset of strings that contain the pattern. | `grep` with `value = TRUE` |
| `str_locate` | Locate | Returns positions of first occurrence of pattern in a string.| `regexpr` |
|  `str_locate_all` | Locate | Returns position of all occurrences of pattern in a string. |`gregexpr` |
| `str_view` | Locate | Show the first part of the string that matches pattern. | |

## `stringr` functions

| stringr     | Task     | Description                              | R-base |
|--------------- |----------|--------------------------------------|-------------|
 | `str_view_all` | Locate | Show me all the parts of the string that match the pattern. | 
| `str_extract` | Extract | Extract the first part of the string that matches the pattern. | |
`str_extract_all` | Extract | Extract all parts of the string that match the pattern. |  |
 | `str_match` | Extract | Extract first part of the string that matches the groups and the patterns defined by the groups.| |
| `str_match_all` | Extract | Extract all parts of the string that matches the groups and the patterns defined by the groups. | |
| `str_sub` | Extract | Extract a substring. | `substring` |

## `stringr` functions

| stringr     | Task     | Description                              | R-base |
|--------------- |----------|--------------------------------------|-------------|
| `str_split` | Extract | Split a string into a list with parts separated by pattern. | `strsplit`|
| `str_split_fixed` | Extract | Split a string into a matrix with parts separated by pattern. | `strsplit` with `fixed = TRUE`|
| `str_count` | Describe | Count number of times a pattern appears in a string.  |   |
| `str_length`| Describe | Number of character in string.  | `nchar` |
| `str_replace` | Replace | Replace first part of a string matching a pattern with another.  | | 

## `stringr` functions

| stringr     | Task     | Description                              | R-base |
|--------------- |----------|--------------------------------------|-------------|
| `str_replace_all`| Replace | Replace all parts of a string matching a pattern with another.  | `gsub` | 
 | `str_to_upper` | Replace | Change all characters to upper case. | `toupper` | 
| `str_to_lower` | Replace | Change all characters to lower case. | `tolower` |
| `str_to_title` | Replace | Change first character to upper and rest to lower. | | 
 | `str_replace_na`| Replace | Replace all `NA`s to a new value. | |
| `str_trim` | Replace | Remove white space from start and end of string. | |

## `stringr` functions

| stringr     | Task     | Description                              | R-base |
|--------------- |----------|--------------------------------------|-------------|
| `str_c`| Manipulate | Join multiple strings.  | `paste0` |
 | `str_conv` | Manipulate | Change the encoding of the string.| |
 | `str_sort` | Manipulate | Sort the vector in alphabetical order.| `sort` |
 | `str_order`| Manipulate | Index needed to order the vector in alphabetical order. | `order` |
| `str_trunc` | Manipulate | Truncate a string to a fixed size. | |
| `str_pad`| Manipulate | Add white space to string to make it a fixed size.  | |

## `stringr` functions

| stringr     | Task     | Description                              | R-base |
|--------------- |----------|--------------------------------------|-------------|
| `str_dup`| Manipulate | Repeat a string.  | `rep` then `paste` |
 | `str_wrap` | Manipulate | Wrap things into formatted paragraphs. | |
| `str_interp` | Manipulate | String interpolation. |  `sprintf` | 

## String length

```{r}
str_length(c("a", "Survey of Modern Statistical Software", 9))
```

## String concatenation

```{r}
str_c("x", "y")
str_c("x", "y", "z")
str_c("x", "y", sep = ", ")
```

## String concatenation

```{r}
x <- c("abc", NA)
str_c("|-", x, "-|")
str_c("|-", str_replace_na(x), "-|")
```

## String subsetting

```{r}
x <- c("Apple", "Banana", "Pear")
str_sub(x, 1, 3)
str_sub(x, -3, -1)
```

## Raw murders

```{r,message=FALSE, warning=FALSE}
library(rvest)
url <- paste0("https://en.wikipedia.org/w/index.php?title=",
              "Gun_violence_in_the_United_States_by_state",
              "&direction=prev&oldid=810166167")
murders_raw <- read_html(url) %>%
  html_node("table") %>%
  html_table() %>%
  setNames(c("state", "population", "total", "murder_rate"))
```

## Raw murders

Converting to numeric from text (even nicely formatted text) is trickier.

```{r}
murders_raw$population[1:3]
```

The usual coercion does not work here:

```{r}
as.numeric(murders_raw$population[1:3])
```

## Detecting commas

We can use the `str_detect` function to see that two of the three columns have commas in the entries:

```{r}
commas <- function(x) any(str_detect(x, ","))
murders_raw %>% summarize_all(commas)
```

## Removing commas

We can then use the `str_replace_all` function to remove them:

```{r}
test_1 <- str_replace_all(murders_raw$population, ",", "")
test_1 <- as.numeric(test_1)
test_1
```

## readr version

```{r}
test_2 <- parse_number(murders_raw$population)
identical(test_1, test_2)
```

## Regular expressions

A regular expression (regex) is a way to describe specific patterns of characters of text.

- any string
- digits: `\d` (have to escape this, so use `\\d`)
- white space: `\s`
- many, many more

## Regular Expressions

- We need a language for telling R about patterns of strings
- The most basic such language is that of **regular expressions**
- Regular expressions **match** sets of strings
- Start with string constants, and build up by allowing "_this_ and then _that_", "either _this_ or _that_", "repeat _this_"
- These rules get expressed in a **grammar**, with special symbols

## str_view

```{r}
yes <- c("5", "6", "5'10", "5 feet", "4'11")
no <- c("", ".", "Five", "six")
s <- c(yes, no)
pattern <- "\\d"
str_view(s, pattern)
```

## str_view_all

```{r}
str_view_all(s, pattern)
```

## Character classes

Define character classes with `[]`, dash for range

```{r}
str_detect(s, "[56]")
str_detect(s, "[4-6]")
```

Be careful, though. `[1-20]` means the characters "1" through "2" or the character "0"

## Anchors

- `^` represents the beginning of a string
- `$` represents the end of a string

## Anchors

```{r}
pattern <- "^\\d$"
yes <- c("1", "5", "9")
no <- c("12", "123", " 1", "a4", "b")
s <- c(yes, no)
str_view_all(s, pattern)
```

## Quantifiers

The pattern for one or two digits is:

```{r}
pattern <- "^\\d{1,2}$"
yes <- c("1", "5", "9", "12")
no <- c("123", "a4", "b")
str_view(c(yes, no), pattern)
```

## More quantifiers

- `*`: zero or more instances of previous character
- `?`: zero or once
- `+`: one or more
- `^`: none (inside hard brackets)
  - uppercase of special character: everything _except_ (`\\S`)
- `{n}`, `{n,}`, `{,m}`, and `{n,m}`


## Fruit

The `fruit` object from `stringr` contains 80 named fruits.

```{r}
head(fruit)
```

## Fruit

Fruits that begin with a vowel:

```{r}
str_subset(fruit, "^[aeiou]")
```

## Groups

In addition to detection, we may want to extract certain elements from our regex.

- Capture groups help here!

```{r}
str_view(fruit, "^([aeiou])")
```

## Groups

```{r}
str_match(fruit, "^([aeiou])")
```

## Groups

How about fruit names that contain vowels?

```{r}
str_view_all(fruit, "([aeiou])")
```

## Groups

```{r}
str_match_all(fruit, "([aeiou])")
```

## Groups

```{r}
str_extract_all(fruit, "([aeiou])")
```

## Groups

The following regex finds each instance of a repeated pair of letters (backreferencing):

```{r}
str_view(fruit, "(..)\\1", match = TRUE)
```

## Groups

```{r}
na.omit(str_match(fruit, "(..)"))
```

## Groups

```{r}
na.omit(str_match(fruit, "(..)\\1"))
```

## Other patterns

```{r}
bananas <- c("banana", "Banana", "BANANA")
#str_view(bananas, "banana")
str_view(bananas, regex("banana"))
```

## Other patterns

```{r}
str_view(bananas, regex("banana", ignore_case = TRUE))
```

## Other patterns

- `multiline=TRUE`: allows matching across multiple lines
- `comments=TRUE`: allows comments and white spaces
- `dotall = TRUE`:  allows `.` to match everything, including `\n`.

## Other patterns

```{r}
words <- str_extract_all(fruit, boundary("word"))
fruit[map_dbl(words, length)==2]
```

## Back to strings

Other common tasks:

- string trimming
- changing lettercase
- string splitting
- recoding

## String trimming

```{r}
hey <- "Hey!  "
cat(hey)
str_trim(hey)
```

## Changing case

```{r}
s <- c("Five feet, eight inches")
str_to_lower(s)
str_to_upper(s)
str_to_title(s)
```

## String splitting

```{r}
str_split(s, ",")
```

## Recoding

```{r eval=FALSE}
gapminder %>% filter(region=="Caribbean") %>%
  mutate(country = recode(country, 
                          `Antigua and Barbuda` = "Barbuda",
                          `Dominican Republic` = "DR",
                          `St. Vincent and the Grenadines` = "St. Vincent",
                          `Trinidad and Tobago` = "Trinidad"))
```

## stringi

- `stringr` is built on top of `stringi`
- `stringr` is simpler, but limited
- `str` vs `stri` functions, but otherwise very similar

## Example - funding rates

Scientific funding rates by gender in the Netherlands:

```{r}
library(dslabs)
data("research_funding_rates")
research_funding_rates %>% 
  select("discipline", "success_rates_men", "success_rates_women")
```

## Example - original paper

(PNAS article)[http://www.pnas.org/content/112/40/12349.abstract]

```{r, echo=FALSE, out.width="90%"}

knitr::include_graphics(file.path("pnas-table-s1.png"))
```

## Example - importing a pdf

The data table was found in a supplemental file provided by the authors

```{r}
library("pdftools")
temp_file <- tempfile()
url <- paste0("http://www.pnas.org/content/suppl/2015/09/16/",
              "1510159112.DCSupplemental/pnas.201510159SI.pdf")
download.file(url, temp_file)
txt <- pdf_text(temp_file)
file.remove(temp_file)
```

## Example - the text file

- `pdf_text` produces one long string per page
- lines end with `\n`, so we can exploit that

```{r}
txt
raw_data_research_funding_rates <- txt[2]
```

## Example - splitting

```{r}
tab <- str_split(raw_data_research_funding_rates, "\n")
tab

tab <- tab[[1]]
```

## Example - column names

Column names are in the third and fourth entries

```{r}
tab
```

## Example - column names

```{r}
the_names_1 <- tab[3]
the_names_2 <- tab[4]
```

## Example - the_names_1

```{r echo=FALSE}
cat(substr(the_names_1, 1, options()$width))
cat(substr(the_names_1, options()$width, nchar(the_names_1)))
```

We need to get these into one vector

- remove leading space
- remove anything following the comma
- split string by 2+ spaces

## Example - the_names_1

```{r}
the_names_1 <- the_names_1 %>%
  str_trim() %>%
  str_replace_all(",\\s.", "") %>%
  str_split("\\s{2,}", simplify = TRUE)
the_names_1 
```

## Example - the_names_2

```{r, echo=FALSE}
cat(substr(the_names_2, 1, options()$width))
cat(substr(the_names_2, options()$width, nchar(the_names_2)))
```

- trim leading spaces
- split by spaces

## Example - the_names_2

```{r}
the_names_2 <- the_names_2 %>%
  str_trim() %>%
  str_split("\\s+", simplify = TRUE)
the_names_2
```

## Example - join names

```{r}
tmp_names <- str_c(rep(the_names_1, each = 3), the_names_2[-1], sep = "_")
the_names <- c(the_names_2[1], tmp_names) %>%
  str_to_lower() %>%
  str_replace_all("\\s", "_")
the_names
```

## Example - the data

```{r}
tab
```

## Example - the data

```{r}
new_research_funding_rates <- tab[6:14] %>%
  str_trim %>%
  str_split("\\s{2,}", simplify = TRUE) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  setNames(the_names) %>%
  mutate_at(-1, parse_number)
new_research_funding_rates %>% as_tibble()
```

## Example - the data

```{r}
new_research_funding_rates %>%
  select(discipline, starts_with("success_rates")) %>%
  as_tibble()
```

## Example - the data

```{r}
new_research_funding_rates %>%
  select(discipline, starts_with("success_rates")) %>% 
  rename_all(funs(stringr::str_replace_all(., "success_rates_", ""))) %>%
  mutate(difference = women - men) %>%
  as_tibble()
```

## Example - plot

```{r}
new_research_funding_rates %>%
  select(discipline, starts_with("success_rates")) %>% 
  rename_all(funs(stringr::str_replace_all(., "success_rates_", ""))) %>%
  mutate(difference = women - men) %>%
  qplot(difference, discipline, data=.)
```

## Reason for factors

```{r}
x1 <- c("Dec", "Apr", "Jan", "Mar")
x2 <- c("Dec", "Apr", "Jam", "Mar")
sort(x1)
```

## Factor levels

```{r}
month_levels <- c(
  "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
)
y1 <- factor(x1, levels = month_levels)
sort(y1)
```

## Factor levels

```{r}
y2 <- factor(x2, levels = month_levels)
y2
y2 <- parse_factor(x2, levels = month_levels)
```

## Reordering factors

```{r}
funding_rates <- new_research_funding_rates %>%
  mutate(discipline = factor(discipline)) %>%
  select(discipline, starts_with("success_rates")) %>% 
  rename_all(funs(stringr::str_replace_all(., "success_rates_", ""))) %>%
  mutate(difference = women - men) 
```

```{r}
funding_rates$discipline <- fct_reorder(.f = funding_rates$discipline, .x = funding_rates$difference)
funding_rates$discipline
```

## Better plot

```{r echo=FALSE}
qplot(difference, discipline, data=funding_rates)
```

## More options

See R4DS Chapter 15 for more options, like:

- `fct_reorder2`: reorder based on two variables
- `fct_relevel`: move factor level(s) to "the front of the line"
- `fct_infreq`: order levels by frequency
- `fct_recode`: recode factor levels (see also `fct_collapse`)
- `fct_lump`: lump together infrequent factor levels
